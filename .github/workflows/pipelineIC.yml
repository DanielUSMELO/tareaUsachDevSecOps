name: Workflow
on:
  push:
    branches:
      - pipeline

jobs:
  SAST:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v2
        with: 
          java-version: '17'
          distribution: 'adopt' 

      - name: Set Environment Variables     
        run: echo "BRANCH_NAME=${{ github.ref_name }}" >> $GITHUB_ENV

       # Triggering SonarQube analysis as results of it are required by Quality Gate check.
      - name: SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@master 
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: https://sonarcloud.io

      - name: SonarQube Quality Gate Check
        id: sonarqube-quality-gate-check
        uses: sonarsource/sonarqube-quality-gate-action@master
        with:
          pollingTimeoutSec: 600
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Validate for Critical, High, or Medium Vulnerabilities
        run: |
          echo "Checking for vulnerabilities..."
          vulnerabilities=$(curl -s -u "$SONAR_TOKEN:" \
            "https://sonarcloud.io/api/issues/search?componentKeys=$SONAR_PROJECT_KEY&types=VULNERABILITY&severities=CRITICAL,HIGH,MEDIUM" | jq -r '.total')
          
          if [ "$vulnerabilities" -gt 0 ]; then
            echo "Found $vulnerabilities vulnerabilities (Critical, High, or Medium). Failing the pipeline."
            exit 1
          else
            echo "No Critical, High, or Medium vulnerabilities found. Continuing pipeline."
          fi
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}